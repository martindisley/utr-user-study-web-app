<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat - LLM Design Evaluator</title>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'ui-sans-serif', 'system-ui']
                    },
                    colors: {
                        brand: {
                            dark: '#111827'
                        }
                    }
                }
            }
        };
    </script>
    <style>
        html, body {
            min-height: 100vh;
            height: 100%;
        }
        
        body {
            font-family: 'Inter', ui-sans-serif, system-ui, -apple-system, 'Segoe UI', Roboto, Helvetica, Arial, 'Apple Color Emoji', 'Segoe UI Emoji';
            background-color: #f9fafb !important;
            background-image:
                radial-gradient(at 15% 15%, rgba(59, 130, 246, 0.12) 0, rgba(249, 250, 251, 0) 50%),
                radial-gradient(at 85% 10%, rgba(236, 72, 153, 0.1) 0, rgba(249, 250, 251, 0) 55%),
                radial-gradient(at 50% 95%, rgba(45, 212, 191, 0.12) 0, rgba(249, 250, 251, 0) 60%);
            background-repeat: no-repeat;
            background-size: 100% 100%;
            background-attachment: fixed;
        }
        .chat-container::-webkit-scrollbar {
            width: 8px;
        }
        .chat-container::-webkit-scrollbar-track {
            background: #f4f4f5;
            border-radius: 4px;
        }
        .chat-container::-webkit-scrollbar-thumb {
            background: #d4d4d8;
            border-radius: 4px;
        }
        .chat-container::-webkit-scrollbar-thumb:hover {
            background: #a1a1aa;
        }
    </style>
</head>
<body class="antialiased text-gray-900 h-screen overflow-hidden">
    <div class="h-full flex flex-col">
    <header class="border-b border-gray-200 bg-transparent flex-shrink-0">
            <div class="max-w-7xl mx-auto w-full px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between py-4">
                    <div>
                        <h1 class="text-lg font-semibold text-gray-900" id="modelName">Loading...</h1>
                        <p class="text-xs text-gray-500" id="userEmail"></p>
                    </div>
                    <button
                        id="newSessionBtn"
                        class="inline-flex items-center justify-center px-4 py-2.5 rounded-lg bg-gray-900 text-white text-sm font-medium hover:bg-gray-800 transition-colors"
                    >
                        End Session & Generate Images
                    </button>
                </div>
            </div>
        </header>

        <main class="flex-1 flex flex-col overflow-hidden min-h-0">
            <div class="max-w-7xl mx-auto w-full px-4 sm:px-6 lg:px-8 py-6 lg:py-10 flex flex-col gap-6 flex-1 overflow-hidden min-h-0">
                <section id="instructionsCard" class="flex-shrink-0 bg-white border border-gray-200 rounded-2xl shadow-sm p-5 flex flex-col gap-4 sm:flex-row sm:items-start sm:justify-between">
                    <div class="text-sm text-gray-700 leading-relaxed" id="instructionsContent"></div>
                    <button
                        id="dismissInstructions"
                        class="self-end sm:self-auto text-sm font-medium text-gray-600 hover:text-gray-900 whitespace-nowrap"
                    >
                        Dismiss
                    </button>
                </section>

                <div class="flex-1 flex flex-col lg:flex-row gap-6 overflow-hidden min-h-0">
                    <section class="flex-1 flex flex-col overflow-hidden min-h-0">
                        <div class="flex-1 flex flex-col rounded-2xl border border-gray-200 bg-white shadow-sm overflow-hidden min-h-0">
                            <div id="messagesContainer" class="flex-1 overflow-y-auto px-4 sm:px-6 py-6 chat-container bg-gray-50 min-h-0">
                                <div id="messages" class="space-y-6">
                                    <!-- Messages injected here -->
                                </div>

                                <div id="typingIndicator" class="hidden flex items-center gap-2 text-sm text-gray-500 mt-4">
                                    <span class="flex gap-1">
                                        <span class="w-2 h-2 rounded-full bg-gray-400 animate-bounce" style="animation-delay:0ms"></span>
                                        <span class="w-2 h-2 rounded-full bg-gray-400 animate-bounce" style="animation-delay:150ms"></span>
                                        <span class="w-2 h-2 rounded-full bg-gray-400 animate-bounce" style="animation-delay:300ms"></span>
                                    </span>
                                    <span>AI is thinking...</span>
                                </div>
                            </div>

                            <div class="border-t border-gray-200 bg-white">
                                <form id="messageForm" class="p-4 sm:p-5 flex flex-col gap-3 sm:flex-row sm:items-end">
                                    <div class="relative flex-1">
                                        <input
                                            type="text"
                                            id="messageInput"
                                            placeholder="Describe what you want to explore..."
                                            class="w-full rounded-xl border border-gray-300 px-4 py-3 pr-12 text-sm focus:border-transparent focus:outline-none focus:ring-2 focus:ring-gray-900"
                                            required
                                        >
                                        <span class="absolute inset-y-0 right-4 flex items-center text-gray-400 pointer-events-none">â†µ</span>
                                    </div>
                                    <div class="flex gap-2 sm:w-auto">
                                        <button
                                            type="submit"
                                            id="sendBtn"
                                            class="px-5 py-3 rounded-xl bg-gray-900 text-white text-sm font-medium hover:bg-gray-800 transition-colors disabled:opacity-60 disabled:cursor-not-allowed"
                                        >
                                            Send
                                        </button>
                                        <button
                                            type="button"
                                            id="resetBtn"
                                            class="px-5 py-3 rounded-xl border border-gray-200 text-sm font-medium text-gray-600 hover:border-gray-300 hover:text-gray-900 transition-colors"
                                        >
                                            Reset Chat
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </section>

                    <aside id="promptPanel" class="w-full lg:w-80 xl:w-96 flex flex-col rounded-2xl border border-gray-200 bg-white shadow-sm flex-shrink-0 overflow-hidden">
                        <div class="border-b border-gray-200 px-5 py-5">
                            <div class="flex items-center justify-between mb-1">
                                <h2 class="text-base font-semibold text-gray-900">Image Prompts</h2>
                                <span class="text-xs font-medium text-gray-500" id="promptCount">&nbsp;</span>
                            </div>
                            <p class="text-sm text-gray-600">Capture image generation prompts you want to use.</p>
                        </div>
                        <div class="flex-1 flex flex-col overflow-hidden min-h-0">
                            <form id="promptForm" class="border-b border-gray-200 p-5 space-y-4">
                                <div class="space-y-2">
                                    <label for="promptTitle" class="text-sm font-medium text-gray-700">Title (optional)</label>
                                    <input
                                        type="text"
                                        id="promptTitle"
                                        maxlength="150"
                                        class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-transparent focus:outline-none focus:ring-2 focus:ring-gray-900"
                                        placeholder="Give this prompt a working title"
                                    >
                                </div>
                                <div class="space-y-2">
                                    <label for="promptContent" class="text-sm font-medium text-gray-700">Prompt text</label>
                                    <textarea
                                        id="promptContent"
                                        rows="6"
                                        class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-transparent focus:outline-none focus:ring-2 focus:ring-gray-900"
                                        placeholder="Write your image generation prompt"
                                        required
                                    ></textarea>
                                </div>
                                <div class="flex justify-end gap-2">
                                    <button
                                        type="button"
                                        id="promptCancelBtn"
                                        class="hidden px-4 py-2 rounded-lg border border-gray-200 text-sm font-medium text-gray-600 hover:border-gray-300 hover:text-gray-900 transition-colors"
                                    >
                                        Cancel
                                    </button>
                                    <button
                                        type="submit"
                                        id="promptSaveBtn"
                                        class="px-4 py-2.5 rounded-lg bg-gray-900 text-white text-sm font-medium hover:bg-gray-800 transition-colors disabled:opacity-60 disabled:cursor-not-allowed"
                                    >
                                        Save Prompt
                                    </button>
                                </div>
                                <p id="promptStatus" class="text-xs text-gray-500"></p>
                            </form>
                            <div class="flex-1 overflow-y-auto p-5 space-y-4" id="promptListContainer">
                                <div id="promptEmptyState" class="text-sm text-gray-400">No prompts saved yet.</div>
                                <div id="promptList" class="space-y-4"></div>
                            </div>
                        </div>
                    </aside>
                </div>
            </div>
        </main>
    </div>

    <!-- Load JavaScript modules -->
    <script src="env.js"></script>
    <script src="js/config.js"></script>
    <script src="js/api.js"></script>
    <script src="js/storage.js"></script>
    
    <!-- Chat page logic -->
    <script>
        // Ensure user session is present
        if (!Storage.isLoggedIn() || !Storage.getSessionId()) {
            window.location.href = 'index.html';
        }

        const modelName = document.getElementById('modelName');
        const userEmail = document.getElementById('userEmail');
        const messagesContainer = document.getElementById('messagesContainer');
        const messages = document.getElementById('messages');
        const messageForm = document.getElementById('messageForm');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const resetBtn = document.getElementById('resetBtn');
        const newSessionBtn = document.getElementById('newSessionBtn');
        const typingIndicator = document.getElementById('typingIndicator');
        const instructionsCard = document.getElementById('instructionsCard');
        const instructionsContent = document.getElementById('instructionsContent');
        const dismissInstructions = document.getElementById('dismissInstructions');

    const promptForm = document.getElementById('promptForm');
        const promptTitle = document.getElementById('promptTitle');
        const promptContent = document.getElementById('promptContent');
        const promptSaveBtn = document.getElementById('promptSaveBtn');
        const promptCancelBtn = document.getElementById('promptCancelBtn');
        const promptStatus = document.getElementById('promptStatus');
        const promptList = document.getElementById('promptList');
        const promptEmptyState = document.getElementById('promptEmptyState');
    const promptCount = document.getElementById('promptCount');

        let prompts = [];
        let editingPromptId = null;
        let promptStatusTimer = null;

        const currentModel = Storage.getCurrentModel();
        modelName.textContent = `Model: ${currentModel}`;
        userEmail.textContent = Storage.getUserEmail();

        instructionsContent.innerHTML = CONFIG.STUDY_INSTRUCTIONS;
        dismissInstructions.addEventListener('click', () => {
            instructionsCard.classList.add('hidden');
        });

        function setPromptStatus(message, type = 'info') {
            if (promptStatusTimer) {
                clearTimeout(promptStatusTimer);
                promptStatusTimer = null;
            }

            const baseClasses = ['text-xs', 'mt-1'];
            let colourClass = 'text-gray-500';
            if (type === 'success') {
                colourClass = 'text-emerald-600';
            } else if (type === 'error') {
                colourClass = 'text-red-600';
            }

            promptStatus.className = [...baseClasses, colourClass].join(' ');
            promptStatus.textContent = message || '';

            if (message) {
                promptStatusTimer = setTimeout(() => {
                    promptStatus.textContent = '';
                    promptStatusTimer = null;
                }, 4000);
            }
        }

        function resetPromptForm() {
            editingPromptId = null;
            promptTitle.value = '';
            promptContent.value = '';
            promptSaveBtn.textContent = 'Save Prompt';
            promptSaveBtn.disabled = false;
            promptCancelBtn.classList.add('hidden');
            promptCancelBtn.disabled = false;
        }

        function renderPrompts() {
            promptList.innerHTML = '';

            if (!prompts.length) {
                promptEmptyState.classList.remove('hidden');
                if (promptCount) {
                    promptCount.textContent = '0';
                }
                return;
            }

            promptEmptyState.classList.add('hidden');
            if (promptCount) {
                promptCount.textContent = prompts.length.toString();
            }

            prompts.forEach((prompt, index) => {
                const card = document.createElement('article');
                card.className = 'border border-gray-200 rounded-xl p-4 bg-white hover:border-gray-300 transition-colors';

                const header = document.createElement('div');
                header.className = 'flex items-start justify-between gap-2';

                const title = document.createElement('h4');
                title.className = 'text-sm font-semibold text-gray-800';
                title.textContent = prompt.title || `Prompt ${index + 1}`;

                const actions = document.createElement('div');
                actions.className = 'flex gap-2';

                const editBtn = document.createElement('button');
                editBtn.type = 'button';
                editBtn.className = 'text-xs font-medium text-gray-500 hover:text-gray-900';
                editBtn.textContent = 'Edit';
                editBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    startEditingPrompt(prompt);
                });

                const deleteBtn = document.createElement('button');
                deleteBtn.type = 'button';
                deleteBtn.className = 'text-xs font-medium text-red-500 hover:text-red-600';
                deleteBtn.textContent = 'Delete';
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    handlePromptDelete(prompt.id);
                });

                actions.appendChild(editBtn);
                actions.appendChild(deleteBtn);

                header.appendChild(title);
                header.appendChild(actions);

                const content = document.createElement('p');
                content.className = 'text-sm text-gray-700 whitespace-pre-wrap break-words mt-2';
                content.textContent = prompt.content;

                const meta = document.createElement('p');
                meta.className = 'text-xs text-gray-400 mt-2';
                const createdAt = new Date(prompt.created_at);
                const updatedAt = new Date(prompt.updated_at);
                const isUpdated = updatedAt.getTime() !== createdAt.getTime();
                meta.textContent = `${isUpdated ? 'Updated' : 'Saved'} ${updatedAt.toLocaleString()}`;

                card.appendChild(header);
                card.appendChild(content);
                card.appendChild(meta);

                if (prompt.source_message_excerpt) {
                    const source = document.createElement('p');
                    source.className = 'text-xs text-gray-500 mt-2 italic';
                    const roleLabel = prompt.source_message_role === 'assistant' ? 'assistant' : 'you';
                    source.textContent = `Referenced from ${roleLabel}: "${prompt.source_message_excerpt}"`;
                    card.appendChild(source);
                }

                promptList.appendChild(card);
            });
        }

        async function loadPrompts() {
            try {
                const sessionId = Storage.getSessionId();
                if (!sessionId) {
                    return;
                }
                const response = await API.getPrompts(sessionId);
                prompts = response.prompts || [];
                renderPrompts();
            } catch (error) {
                console.error('Error loading prompts:', error);
                setPromptStatus('Could not load prompts. Please refresh to try again.', 'error');
            }
        }

        function startEditingPrompt(prompt) {
            editingPromptId = prompt.id;
            promptTitle.value = prompt.title || '';
            promptContent.value = prompt.content;
            promptSaveBtn.textContent = 'Update Prompt';
            promptCancelBtn.classList.remove('hidden');
            promptContent.focus();
            setPromptStatus('Editing prompt. Update the notes and press Update Prompt to save.', 'info');
        }

        async function handlePromptDelete(promptId) {
            try {
                await API.deletePrompt(promptId);
                if (editingPromptId === promptId) {
                    resetPromptForm();
                }
                await loadPrompts();
                setPromptStatus('Prompt deleted.', 'success');
            } catch (error) {
                console.error('Error deleting prompt:', error);
                setPromptStatus(error.message || 'Failed to delete prompt.', 'error');
            }
        }

        promptForm.addEventListener('submit', async (event) => {
            event.preventDefault();

            const sessionId = Storage.getSessionId();
            if (!sessionId) {
                setPromptStatus('Session missing. Please refresh the page.', 'error');
                return;
            }

            const title = promptTitle.value.trim();
            const content = promptContent.value.trim();

            if (!content) {
                setPromptStatus('Please add some concept notes before saving.', 'error');
                promptContent.focus();
                return;
            }

            const payload = {
                content,
                title: title || null,
            };

            const isEditing = Boolean(editingPromptId);
            const originalLabel = promptSaveBtn.textContent;

            promptSaveBtn.disabled = true;
            promptSaveBtn.textContent = isEditing ? 'Updating...' : 'Saving...';
            promptCancelBtn.disabled = true;

            try {
                if (isEditing) {
                    await API.updatePrompt(editingPromptId, payload);
                    setPromptStatus('Prompt updated.', 'success');
                } else {
                    await API.createPrompt(sessionId, payload);
                    setPromptStatus('Prompt saved.', 'success');
                }

                resetPromptForm();
                await loadPrompts();
            } catch (error) {
                console.error('Error saving concept:', error);
                setPromptStatus(error.message || 'Failed to save prompt.', 'error');
            } finally {
                promptSaveBtn.disabled = false;
                promptSaveBtn.textContent = originalLabel;
                promptCancelBtn.disabled = false;
            }
        });

        promptCancelBtn.addEventListener('click', () => {
            resetPromptForm();
            setPromptStatus('Editing cancelled.', 'info');
        });

        function createMessageBubble(role, content, timestamp) {
            const wrapper = document.createElement('div');
            const timeLabel = timestamp
                ? new Date(timestamp).toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' })
                : '';

            if (role === 'user') {
                wrapper.className = 'flex justify-end';

                const contentGroup = document.createElement('div');
                contentGroup.className = 'flex flex-col items-end gap-2 max-w-[75%]';

                const bubble = document.createElement('div');
                bubble.className = 'rounded-2xl rounded-tr-sm bg-gray-900 text-white px-4 py-3 shadow-sm';

                const text = document.createElement('p');
                text.className = 'text-sm whitespace-pre-wrap break-words leading-relaxed';
                text.textContent = content;

                bubble.appendChild(text);
                contentGroup.appendChild(bubble);

                if (timeLabel) {
                    const time = document.createElement('span');
                    time.className = 'text-xs text-gray-400';
                    time.textContent = timeLabel;
                    contentGroup.appendChild(time);
                }

                wrapper.appendChild(contentGroup);
                return wrapper;
            }

            wrapper.className = 'flex gap-3 items-start max-w-[80%]';

            const avatar = document.createElement('div');
            avatar.className = 'w-8 h-8 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-xs font-semibold text-white shadow-sm';
            avatar.textContent = 'AI';

            const contentContainer = document.createElement('div');
            contentContainer.className = 'flex-1';

            const bubble = document.createElement('div');
            bubble.className = 'rounded-2xl rounded-tl-sm border border-gray-200 bg-white px-4 py-3 shadow-sm';

            const text = document.createElement('p');
            text.className = 'text-sm text-gray-800 whitespace-pre-wrap break-words leading-relaxed';
            text.textContent = content;

            bubble.appendChild(text);
            contentContainer.appendChild(bubble);

            if (timeLabel) {
                const time = document.createElement('span');
                time.className = 'text-xs text-gray-400 mt-2 block';
                time.textContent = timeLabel;
                contentContainer.appendChild(time);
            }

            wrapper.appendChild(avatar);
            wrapper.appendChild(contentContainer);

            return wrapper;
        }

        function addMessage(role, content, timestamp) {
            const messageBubble = createMessageBubble(role, content, timestamp);
            messages.appendChild(messageBubble);
            scrollToBottom();
        }

        function scrollToBottom() {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function setTyping(isTyping) {
            if (isTyping) {
                typingIndicator.classList.remove('hidden');
                scrollToBottom();
            } else {
                typingIndicator.classList.add('hidden');
            }
        }

        messageForm.addEventListener('submit', async (event) => {
            event.preventDefault();

            const message = messageInput.value.trim();
            if (!message) {
                return;
            }

            messageInput.disabled = true;
            sendBtn.disabled = true;

            addMessage('user', message, new Date().toISOString());
            messageInput.value = '';
            setTyping(true);

            try {
                const sessionId = Storage.getSessionId();
                const response = await API.sendMessage(sessionId, message);
                setTyping(false);
                addMessage('assistant', response.response, response.timestamp);
            } catch (error) {
                console.error('Error sending message:', error);
                setTyping(false);
                addMessage('assistant', `Error: ${error.message}. Please try again.`, new Date().toISOString());
            } finally {
                messageInput.disabled = false;
                sendBtn.disabled = false;
                messageInput.focus();
            }
        });

        resetBtn.addEventListener('click', async () => {
            try {
                const sessionId = Storage.getSessionId();
                const response = await API.resetSession(sessionId);

                const updatedSessionId = response.session_id ?? sessionId;
                Storage.saveSession(updatedSessionId, currentModel);
                messages.innerHTML = '';
                const clearedMessages = response.cleared_messages ?? 0;
                const resetNotice = clearedMessages > 0
                    ? `Cleared ${clearedMessages} message${clearedMessages === 1 ? '' : 's'} from this session. Your saved prompts remain available.`
                    : 'Chat context cleared. Your saved prompts remain available in the Prompts panel.';
                addMessage('assistant', resetNotice, new Date().toISOString());
                if (response.ollama_cleared === false) {
                    addMessage('assistant', 'Note: Could not confirm the model cleared its internal context. If responses seem off, use "End Session & Generate Images" from the header.', new Date().toISOString());
                }

                instructionsCard.classList.remove('hidden');

                resetPromptForm();
                prompts = [];
                renderPrompts();
                await loadPrompts();
                setPromptStatus('Chat reset. Existing prompts are still here; capture new ideas as you go.', 'info');
            } catch (error) {
                console.error('Error resetting session:', error);
                alert('Failed to reset chat. Please try again.');
            }
        });

        newSessionBtn.addEventListener('click', async () => {
            const sessionId = Storage.getSessionId();
            
            // Check if there are any prompts
            if (!prompts || prompts.length === 0) {
                if (!confirm('You haven\'t saved any prompts yet. Are you sure you want to end this session?')) {
                    return;
                }
                // No prompts, just go to model selection
                Storage.clearSession();
                window.location.href = 'select-model.html';
                return;
            }
            
            // Disable button and show loading state
            newSessionBtn.disabled = true;
            newSessionBtn.textContent = 'Generating images...';
            
            try {
                // Call end session API which triggers image generation
                const response = await API.endSession(sessionId);
                
                if (response.success) {
                    // Navigate to gallery page with session ID
                    window.location.href = `gallery.html?session=${sessionId}`;
                } else {
                    throw new Error(response.message || 'Failed to end session');
                }
            } catch (error) {
                console.error('Error ending session:', error);
                alert('Failed to generate images. Please try again.');
                newSessionBtn.disabled = false;
                newSessionBtn.textContent = 'End Session & Generate Images';
            }
        });

        addMessage('assistant', 'Hello! I\'m ready to help you develop image generation prompts. Feel free to ask me anything!', new Date().toISOString());
        messageInput.focus();

        loadPrompts();
        setPromptStatus('Use the Prompts panel to capture the prompts you want to keep.', 'info');
    </script>
</body>
</html>
