<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LLM Design Ideation Evaluator - Login</title>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'ui-sans-serif', 'system-ui']
                    },
                }
            }
        };
    </script>
    <style>
        html, body {
            min-height: 100vh;
            height: 100%;
        }
        
        body {
            font-family: 'Inter', ui-sans-serif, system-ui, -apple-system, 'Segoe UI', Roboto, Helvetica, Arial, 'Apple Color Emoji', 'Segoe UI Emoji';
            background-color: #f9fafb !important;
            background-image:
                radial-gradient(at 20% 20%, rgba(99, 102, 241, 0.12) 0, rgba(249, 250, 251, 0) 50%),
                radial-gradient(at 75% 10%, rgba(236, 72, 153, 0.12) 0, rgba(249, 250, 251, 0) 55%),
                radial-gradient(at 50% 95%, rgba(45, 212, 191, 0.12) 0, rgba(249, 250, 251, 0) 60%);
            background-repeat: no-repeat;
            background-size: 100% 100%;
            background-attachment: fixed;
        }
    </style>
</head>
<body class="antialiased text-gray-900">
    <div class="min-h-screen flex items-center justify-center pt-6">
    <div class="w-full max-w-xl bg-white rounded-2xl border border-gray-200 shadow-lg p-10">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-light tracking-tight text-gray-900 mb-2">Unlearning to Rest: User Study</h1>
                <p class="text-sm text-gray-600">This study aims to evaluate the efficacy concept suppression, or 'unlearning', as a method of Large Language Model (LLM) augmentation for the task of creative ideation. In other words, we want to test if making LLMs 'forget' certain ideas makes them better conversational partners for creative brainstorming.
</p>
            </div>

            <div id="loginForm" class="space-y-6">

                <form id="emailForm" class="space-y-4">
                    <div>
                        <label for="email" class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                        <input
                            type="email"
                            id="email"
                            name="email"
                            required
                            placeholder="your@email.com"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-900 focus:border-transparent outline-none"
                        >
                        <p id="emailError" class="text-red-500 text-sm mt-1 hidden"></p>
                    </div>

                    <button
                        type="submit"
                        id="submitBtn"
                        class="w-full bg-gray-900 text-white py-3 rounded-lg font-medium hover:bg-gray-800 transition-colors flex items-center justify-center"
                    >
                        <span id="btnText">Sign In</span>
                        <span id="btnSpinner" class="hidden ml-2">
                            <svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                        </span>
                    </button>
                </form>

                <div id="successMessage" class="hidden p-4 bg-green-50 border border-green-200 rounded-lg">
                    <p class="text-green-700 text-sm text-center">
                        âœ“ Login successful! Redirecting...
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Load JavaScript modules -->
    <script src="env.js"></script>
    <script src="js/config.js"></script>
    <script src="js/api.js"></script>
    <script src="js/storage.js"></script>
    
    <!-- Login page logic -->
    <script>
        // Check if user is already logged in
        if (Storage.isLoggedIn()) {
            // Check if study is completed
            if (Storage.getStudyCompleted()) {
                // Study already completed, don't allow re-entry
                alert('You have already completed this study. Thank you for your participation!');
                Storage.clearAll();
            } else {
                // Check if pre-activity questionnaire is completed
                if (Storage.getPreActivityCompleted()) {
                    window.location.href = 'moodboard.html';
                } else {
                    window.location.href = 'pre-activity-questionnaire.html';
                }
            }
        }

        const emailForm = document.getElementById('emailForm');
        const emailInput = document.getElementById('email');
        const emailError = document.getElementById('emailError');
        const submitBtn = document.getElementById('submitBtn');
        const btnText = document.getElementById('btnText');
        const btnSpinner = document.getElementById('btnSpinner');
        const successMessage = document.getElementById('successMessage');

        // Validate email format
        function validateEmail(email) {
            return CONFIG.APP_CONFIG.emailRegex.test(email);
        }

        // Show error message
        function showError(message) {
            emailError.textContent = message;
            emailError.classList.remove('hidden');
            emailInput.classList.add('border-red-500');
        }

        // Clear error message
        function clearError() {
            emailError.classList.add('hidden');
            emailInput.classList.remove('border-red-500');
        }

        // Set loading state
        function setLoading(loading) {
            submitBtn.disabled = loading;
            if (loading) {
                btnText.classList.add('hidden');
                btnSpinner.classList.remove('hidden');
                submitBtn.classList.add('opacity-75', 'cursor-not-allowed');
            } else {
                btnText.classList.remove('hidden');
                btnSpinner.classList.add('hidden');
                submitBtn.classList.remove('opacity-75', 'cursor-not-allowed');
            }
        }

        // Handle form submission
        emailForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            clearError();

            const email = emailInput.value.trim();

            // Validate email
            if (!email) {
                showError('Email is required');
                return;
            }

            if (!validateEmail(email)) {
                showError('Please enter a valid email address');
                return;
            }

            // Submit to API
            setLoading(true);

            try {
                const response = await API.login(email);
                
                // Save user data
                Storage.saveUser(response.user_id, response.email);

                // Check study status from backend
                try {
                    const status = await API.getStudyStatus(response.user_id);
                    
                    // Sync frontend state with backend
                    if (status.study_completed) {
                        Storage.setStudyCompleted(true);
                        alert('You have already completed this study. Thank you for your participation!');
                        Storage.clearAll();
                        setLoading(false);
                        return;
                    }
                    
                    if (status.pre_activity_completed) {
                        Storage.setPreActivityCompleted(true);
                    }
                    
                    // Set activity count from backend
                    localStorage.setItem('activityCount', status.completed_activities.toString());
                    
                } catch (statusError) {
                    console.error('Error checking study status:', statusError);
                    // Continue anyway - better to let them in than block them
                }

                // Show success message
                successMessage.classList.remove('hidden');

                // Redirect to pre-activity questionnaire
                setTimeout(() => {
                    window.location.href = 'pre-activity-questionnaire.html';
                }, 1000);

            } catch (error) {
                console.error('Login error:', error);
                showError(error.message || 'Failed to login. Please try again.');
                setLoading(false);
            }
        });

        // Clear error on input
        emailInput.addEventListener('input', clearError);
    </script>
</body>
</html>